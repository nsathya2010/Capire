/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/core/XMLComposite","sap/base/Log","sap/ui/model/json/JSONModel","sap/m/Tokenizer","sap/m/Token","sap/ui/core/ValueState","sap/ui/core/theming/Parameters","sap/ui/model/odata/v4/ODataModel","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(X,L,J,T,a,V,P,O,F,b){var E=X.extend("orion.maintreq.manage.controls.EventPrioritizationDialog",{metadata:{properties:{label:"string",value:"string",busy:{type:"boolean",defaultValue:false},url:{type:"string",defaultValue:"/sap/opu/odata4/sap/ui_prioritization_profile/srvd_a2x/sap/ui_prioritization_profile/0001/"},priorityColorCodeMap:{type:"object",defaultValue:{}},isCustomizingAvailablePromise:{type:"object"},selectedItemsPromise:{type:"object",defaultValue:Promise.resolve([])},priorityMapPromise:{type:"object",defaultValue:Promise.resolve({})},selectedItems:{type:"array",defaultValue:[]},epmEnabled:{type:"boolean",defaultValue:true},EntityName:{type:"string",defaultValue:"MaintEvtPrioznPrfl"},FunctionImportName:{type:"string",defaultValue:"SAP__self.CalculateMaintEventPriority"},NotificationType:{type:"string",defaultValue:"M1"},Plant:{type:"string",defaultValue:"1710"},EventPrioritizationProfile:"string",bReload:{type:"boolean",defaultValue:false}},events:{cancel:{},apply:{parameters:{priority:"string",priorityDesc:"string",priorityType:"string",EventPrioritizationProfile:"string",selectedItems:"array",lacdDate:"string",requiredStartTime:"string",requiredEndTime:"string"}}}},Constants:{STATUS:{SUCCESS:"success"},CRITICALITY:{"3":V.Success,"2":V.Warning,"1":V.Error,"0":V.None},INITIALTEMPLATE:{maintPriority:"",maintPriorityDesc:"",lacdDate:"",leadingLikelihood:"",leadingLikelihoodText:"",leadingConsequenceText:"",leadingConsequence:"",leadingConsequenceCategory:"",leadingConsequenceCategoryText:"",selectedItems:[],list:[]},OPERATORS:{AND:"and",EQ:"eq"},FIELDS:{PLANT:"Plant",NOTIFICATION_TYPE:"NotificationType",MAINTEVENTPRIOZNPROFILELABEL:"MaintEventPrioznProfileLabel",MAINTEVENTPRIOZNPRFL:"MaintEvtPrioritizationProfile",CONSEQUENCE_GROUP:"MaintEventConsequenceGroup",CONSEQUENCE_CATEGORY_CODE:"MaintEventCnsqncCategoryCode",CONSEQUENCE_CATEGORY_TITLE:"MaintEventCnsqncCategoryTitle",CONSEQUENCE_CATEGORY_SUB_TITLE:"MaintEvtCnsqncCategorySubTitle",CONSEQUENCE_CATEGORY_POSITION:"MaintEvtCnsqncCatPositionValue",CONSEQUENCE_CODE:"MaintEventConsequenceCode",CONSEQUENCE_TEXT:"MaintEvtConsequenceDescription",CONSEQUENCE_POSITION:"MaintEventCnsqncPositionValue",LIKELIHOOD_CODE:"MaintEventLikelihoodCode",LIKELIHOOD_TEXT:"MaintEvtLikelihoodDescription",LIKELIHOOD_POSITION:"MaintEvtLklihdPositionValue",MAINTPRIORITY:"MaintPriority",MAINTPRIORITYDESC:"MaintPriorityDesc",MAINTPRIORITYTYPE:"MaintPriorityType",LACD_DATE:"LACD_DATE",SELECTED_VALUES:"SELECTED_VALUES",LEADING_VALUES:"LEADING_VALUES",REQUIRED_START_DATE:"REQUIRED_START_DATE",REQUIRED_END_DATE:"REQUIRED_END_DATE",REQUIRED_START_TIME:"REQUIRED_START_TIME",REQUIRED_END_TIME:"REQUIRED_END_TIME"}},sRequiredStartDate:null,sRequiredEndDate:null,sRequiredStartTime:null,sRequiredEndTime:null,priorityType:null,init:function(){var m=new J(Object.create(this.Constants.INITIALTEMPLATE));this.setModel(m,"epmModel");},_onTokenUpdate:function(e){var t;if(e.getParameter("type")===T.TokenUpdateType.Removed){t=e.getParameter("removedTokens");this.removeTokensFromModel(t);this.getCalculatedFields();}},removeTokensFromModel:function(t){t=t.map(function(i){return i.getBindingContext("epmModel").getProperty("consequenceKey");});var s=this.getModel("epmModel").getProperty("/selectedItems");var l=this.getModel("epmModel").getProperty("/list");l=l.map(function(o){if(t.indexOf(o.consequenceKey)!==-1){if(o.severities[o.selectedConsequence]){o.severities[o.selectedConsequence].selected=false;}if(o.likelihood[o.selectedLikelihood]){o.likelihood[o.selectedLikelihood].selected=false;}o.selectedConsequence=-1;o.selectedLikelihood=-1;}return o;});s=s.filter(function(i){return t.indexOf(i.consequenceKey)===-1;});if(s.length===0){this.getModel("epmModel").setProperty("/assesButtonEnabled",false);}this.getModel("epmModel").setProperty("/list",l);this.getModel("epmModel").setProperty("/selectedItems",s);},enableAssessButton:function(s){return s.length>0;},clearAssessmentResult:function(){this.getModel("epmModel").setProperty("/maintPriority","");this.getModel("epmModel").setProperty("/maintPriorityDesc","");this.getModel("epmModel").setProperty("/lacdDate","");this.getModel("epmModel").setProperty("/leadingLikelihood","");this.getModel("epmModel").setProperty("/leadingLikelihoodText","");this.getModel("epmModel").setProperty("/leadingConsequenceText","");this.getModel("epmModel").setProperty("/leadingConsequence","");this.getModel("epmModel").setProperty("/leadingConsequenceCategory","");this.getModel("epmModel").setProperty("/leadingConsequenceCategoryText","");},onConsequenceChanged:function(e){var c=e.getSource().getBindingContext("epmModel");if(c.getProperty("selectedLikelihood")!==-1&&c.getProperty("selectedConsequence")!==-1){this.addTokenToMultiInput(c);this.getCalculatedFields();}},onLikelihoodChnaged:function(e){var c=e.getSource().getBindingContext("epmModel");if(c.getProperty("selectedLikelihood")!==-1&&c.getProperty("selectedConsequence")!==-1){this.addTokenToMultiInput(c);this.getCalculatedFields();}},getPriorityForConsequenceLikelihood:function(n,c,d){if(d!==-1&&c!==-1){var p=this.getPriorityForConsequenceLikelihoodIndex(n,c,d);var m=this.getProperty("priorityColorCodeMap");if(m&&p&&m.hasOwnProperty(p.priority)){return m[p.priority].MaintPriorityDesc;}else{return(p&&p.priority)||"";}}else{return"";}},removeSelection:function(e){var t=[e.getSource()];this.removeTokensFromModel(t);},onLikelihoodListSelectionChange:function(e){var c=e.getSource().getBindingContext("epmModel");var s=e.getSource().getSelectedItem().getBindingContext("epmModel").getObject();this.getModel("epmModel").setProperty(c.getPath()+"/selectedLikelihood",c.getProperty("likelihood").indexOf(s));if(c.getProperty("selectedLikelihood")!==-1&&c.getProperty("selectedConsequence")!==-1){this.addTokenToMultiInput(c);}},onConsequenceListSelectionChange:function(e){var c=e.getSource().getBindingContext("epmModel");var s=e.getSource().getSelectedItem().getBindingContext("epmModel").getObject();this.getModel("epmModel").setProperty(c.getPath()+"/selectedConsequence",c.getProperty("severities").indexOf(s));if(c.getProperty("selectedLikelihood")!==-1&&c.getProperty("selectedConsequence")!==-1){this.addTokenToMultiInput(c);}},addTokenToMultiInput:function(c,s){var n,d,S,o,C,e,p,f,g;if(c){n=c.getProperty("selectedConsequence");d=c.getProperty("selectedLikelihood");S=c.getProperty("severities")[n];o=c.getProperty("likelihood")[d];C=c.getProperty("consequence");p=c.getProperty("priorityMap");f=c.getProperty("consequenceKey");e=c.getProperty("consequenceDescription");g=c.getProperty("consequenceGroup");}else if(s){n=s.selectedConsequence;d=s.selectedLikelihood;S=s.severities[n];o=s.likelihood[d];C=s.consequence;e=s.consequenceDescription;p=s.priorityMap;f=s.consequenceKey;g=s.consequenceGroup;}var h="";var i="";if(p.hasOwnProperty(S.key)){h=p[S.key][o.key]&&p[S.key][o.key].priority;i=p[S.key][o.key]&&p[S.key][o.key].priorityType;}var j=this.getModel("epmModel").getProperty("/selectedItems");var I=j.some(function(k,l){if(k.consequenceKey===f){j[l].consequenceText=C;j[l].consequenceDescription=e;j[l].severityText=S.severityText;j[l].severityKey=S.key;j[l].likelihoodKey=o.key;j[l].likelihoodText=o.likelihoodText;j[l].MaintEventOccrenPosition=o.MaintEventOccrenPosition;j[l].consequenceGroup=g;j[l].priority=h;j[l].priorityType=i;return true;}else{return false;}});if(!I){j.push({consequenceKey:f,consequenceText:C,consequenceDescription:e,severityText:S.severityText,severityKey:S.key,likelihoodKey:o.key,likelihoodText:o.likelihoodText,MaintEventOccrenPosition:o.MaintEventOccrenPosition,consequenceGroup:g,priority:h,priorityType:i});}this.getModel("epmModel").setProperty("/assesButtonEnabled",true);this.getModel("epmModel").setProperty("/selectedItems",j);},concatIdAndDescription:function(d,i){if(d&&d.trim()){return d+((i)?" ("+i+")":"");}else if(i&&i.trim()){return i;}else{return"";}},setConsequenceGroupHighlight:function(n,c,d){if(d!==-1&&c!==-1){var p=this.getPriorityForConsequenceLikelihoodIndex(n,c,d);var C=this.getCriticalityForPriority(p&&p.priority);return C;}else{return V.None;}},getCriticalityForPriority:function(p){var m=this.getProperty("priorityColorCodeMap");if(p&&m&&m.hasOwnProperty(p)){return this.Constants.CRITICALITY[m[p].MaintPriorityColorCode];}else{return V.None;}},getPriorityDescription:function(p){var m=this.getProperty("priorityColorCodeMap");if(p&&m&&m.hasOwnProperty(p)){return m[p].MaintPriorityDesc;}else{return p;}},getPriorityForConsequenceLikelihoodIndex:function(n,c,d){var l=this.getModel("epmModel").getProperty("/list"),o=null;if(!l){return;}for(var i=0;i<l.length;i++){if(l[i].consequenceKey===n){o=l[i];break;}}if(o){var e=o.severities[c].key,f=o.likelihood[d].key,s=o.priorityMap[e][f];return s;}else{return null;}},mapSelectedItems:function(s){var t=this;var m=s.map(function(i){var M={};M[t.Constants.FIELDS.PLANT.toUpperCase()]=t.getProperty("Plant");M[t.Constants.FIELDS.NOTIFICATION_TYPE.toUpperCase()]=t.getProperty("NotificationType");M[t.Constants.FIELDS.MAINTEVENTPRIOZNPRFL.toUpperCase()]=t.EventPrioritizationProfile;M[t.Constants.FIELDS.CONSEQUENCE_GROUP.toUpperCase()]=i.consequenceGroup;M[t.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE.toUpperCase()]=i.consequenceKey;M[t.Constants.FIELDS.CONSEQUENCE_CODE.toUpperCase()]=i.severityKey;M[t.Constants.FIELDS.LIKELIHOOD_CODE.toUpperCase()]=i.likelihoodKey;M[t.Constants.FIELDS.MAINTPRIORITY.toUpperCase()]=i.priority;M[t.Constants.FIELDS.MAINTPRIORITYTYPE.toUpperCase()]=i.priorityType;return M;});return m;},getCalculatedFields:function(){var t=this;var r={};var s=t.getModel("epmModel").getProperty("/selectedItems");if(s.length===0){t.clearAssessmentResult();return;}r[t.Constants.FIELDS.SELECTED_VALUES]=t.mapSelectedItems(s);L.debug(r);new Promise(function(c){$.post({url:t.getProperty("url")+t.getProperty("EntityName")+"/"+t.getProperty("FunctionImportName"),headers:{"x-csrf-token":t.csrfToken,"Content-Type":"application/json"},data:JSON.stringify(r),success:c});}).then(function(d){if(d&&d.value&&d.value[0]){var R=d.value[0];var p=R[t.Constants.FIELDS.MAINTPRIORITYDESC.toUpperCase()];var c=R[t.Constants.FIELDS.MAINTPRIORITY.toUpperCase()];var l=R[t.Constants.FIELDS.LACD_DATE];var e=R[t.Constants.FIELDS.LEADING_VALUES][0];var f=e[t.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE.toUpperCase()];var g=e[t.Constants.FIELDS.CONSEQUENCE_CODE.toUpperCase()];var h=e[t.Constants.FIELDS.LIKELIHOOD_CODE.toUpperCase()];t.getModel("epmModel").setProperty("/leadingConsequence",g);t.getModel("epmModel").setProperty("/leadingLikelihood",h);t.getModel("epmModel").setProperty("/leadingConsequenceCategory",f);t.getModel("epmModel").setProperty("/maintPriority",c);t.getModel("epmModel").setProperty("/maintPriorityDesc",p);t.getModel("epmModel").setProperty("/lacdDate",l);t.getModel("epmModel").setProperty("/leadingConsequenceText",t.oTraversedSeverity[Number(f)][Number(g)]);t.getModel("epmModel").setProperty("/leadingLikelihoodText",t.oTraversedLikelihood[Number(f)][Number(h)]);t.getModel("epmModel").setProperty("/leadingConsequenceCategoryText",t.oTraversedSeverity[Number(f)].text);t.sRequiredStartDate=R[t.Constants.FIELDS.REQUIRED_START_DATE];t.sRequiredEndDate=R[t.Constants.FIELDS.REQUIRED_END_DATE];t.sRequiredStartTime=R[t.Constants.FIELDS.REQUIRED_START_TIME];t.sRequiredEndTime=R[t.Constants.FIELDS.REQUIRED_END_TIME];}else{Promise.reject();}}).catch(function(e){L.error(e);});},open:function(){var p=this.getEventPrioCustomizingData(),t=this;p.then(function(d){t.byId("idEPMDialog").open();});this.initDialog();return p;},getFilterQuery:function(v,s,o){var S=" ";var C="'";var c=this.Constants.OPERATORS.EQ;var A=this.Constants.OPERATORS.AND;var q="";switch(o){case this.Constants.OPERATORS.EQ:q=v+S+c+S+C+s+C;break;case this.Constants.OPERATORS.AND:q=v+S+A+S+s;break;}return q;},getEventPrioCustomizingData:function(){var t=this;var p=this.getFilterQuery(this.Constants.FIELDS.PLANT,this.getProperty("Plant"),this.Constants.OPERATORS.EQ);var n=this.getFilterQuery(this.Constants.FIELDS.NOTIFICATION_TYPE,this.getProperty("NotificationType"),this.Constants.OPERATORS.EQ);var f=this.getFilterQuery(p,n,this.Constants.OPERATORS.AND);var g=new Promise(function(r,c){t._queryEPMCustomizingData(t.getProperty("url")+t.getProperty("EntityName")+"/$count",{$filter:f}).then(function(d){if(parseInt(d,10)){t._queryEPMCustomizingData(t.getProperty("url")+t.getProperty("EntityName"),{$filter:f,$top:d}).then(function(d){if(d&&d.value&&d.value.length!==0){r(d.value);}else{c();}});}else{c();}});});t.setProperty("isCustomizingAvailablePromise",g);return g;},_queryEPMCustomizingData:function(u,d){var t=this;return new Promise(function(r,c){$.get({url:u,headers:{"x-csrf-token":"fetch"},data:d,success:function(e,s,x){t.csrfToken=x.getResponseHeader("x-csrf-token");if(s===t.Constants.STATUS.SUCCESS&&e){r(e);}else{c();}}});});},initDialog:function(){var t=this;var n=t.byId("empNavContainer");var A=false;if(!t.getEpmEnabled()){var d=t.byId("idEpmPageDisplayConsequences");n.to(d);}else{var e=t.byId("idEpmPageEditConsequences");n.to(e);A=true;}t.getModel("epmModel").setProperty("/selectedItems",[]);t.clearAssessmentResult();t.getModel("epmModel").setProperty("/assesButtonEnabled",false);t.getModel("epmModel").setProperty("/assesButtonVisible",A);t.setProperty("busy",true);var p=Promise.all([t.getProperty("isCustomizingAvailablePromise"),t.getProperty("selectedItemsPromise"),t.getProperty("priorityMapPromise")]);p.then(function(r){t.setProperty("priorityColorCodeMap",r[2]);t.setProperty("selectedItems",r[1]);return t._mapViewData.call(t,r[0]);}).then(function(v){return t.setSelectedItems.call(t,v);}).then(function(v){var c=t.objectValues(v);if(c&&c.length===0){Promise.reject();}t.getModel("epmModel").setProperty("/list",c);var f=t.byId("idEmpFlexBoxCategoryListEdit");var o=f&&f.getItems()&&f.getItems()[0];if(o&&t.getModel("epmModel").getProperty("/selectedItems").length===0){o.setExpanded(true);}t.setProperty("busy",false);if(!t.getEpmEnabled()){t.getCalculatedFields();}}).catch(function(c){t.setProperty("busy",false);L.error(c);});},setSelectedItems:function(v){var s=this.getProperty("selectedItems");if(v&&s.length){s.forEach(function(S){var c=v[S[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]],d=c.likelihood,C=c.severities;if(S[this.Constants.FIELDS.MAINTEVENTPRIOZNPRFL]===this.EventPrioritizationProfile){for(var i=0,n=d.length;i<n;i++){if(d[i].key===S[this.Constants.FIELDS.LIKELIHOOD_CODE]){c.selectedLikelihood=i;d[i].selected=true;break;}}for(var j=0,l=C.length;j<l;j++){if(C[j].key===S[this.Constants.FIELDS.CONSEQUENCE_CODE]){c.selectedConsequence=j;C[j].selected=true;break;}}if(c.selectedConsequence!==-1&&c.selectedLikelihood!==-1){this.addTokenToMultiInput(null,c);}}}.bind(this));}return v;},objectValues:function(m){var v=[];for(var k in m){if(m.hasOwnProperty(k)){v.push(m[k]);}}return v;},_mapViewData:function(v){return new Promise(function(r,c){this.oTraversedSeverity={};this.oTraversedLikelihood={};var _=function(A,C,i){if(i){this.EventPrioritizationProfile=C[this.Constants.FIELDS.MAINTEVENTPRIOZNPRFL];A[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]]={consequenceKey:C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE],consequence:C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_TITLE],consequenceGroup:C[this.Constants.FIELDS.CONSEQUENCE_GROUP],consequenceDescription:C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_SUB_TITLE],consequencePosition:C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_POSITION],selectedItem:null,priorityMap:{},selectedConsequence:-1,selectedLikelihood:-1,severities:[],likelihood:[]};this.oTraversedSeverity[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]]={};this.oTraversedSeverity[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]].text=C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_TITLE];this.oTraversedLikelihood[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]]={};this.oTraversedLikelihood[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]].text=C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_TITLE];}if(!this.oTraversedSeverity[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]].hasOwnProperty(C[this.Constants.FIELDS.CONSEQUENCE_CODE])){A[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]].severities.push({key:C[this.Constants.FIELDS.CONSEQUENCE_CODE],severityText:C[this.Constants.FIELDS.CONSEQUENCE_TEXT],MaintEventSvrtyPosition:C[this.Constants.FIELDS.CONSEQUENCE_POSITION]});this.oTraversedSeverity[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]][C[this.Constants.FIELDS.CONSEQUENCE_CODE]]=C[this.Constants.FIELDS.CONSEQUENCE_TEXT];}if(!this.oTraversedLikelihood[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]].hasOwnProperty(C[this.Constants.FIELDS.LIKELIHOOD_CODE])){A[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]].likelihood.push({key:C[this.Constants.FIELDS.LIKELIHOOD_CODE],likelihoodText:C[this.Constants.FIELDS.LIKELIHOOD_TEXT],MaintEventOccrenPosition:C[this.Constants.FIELDS.LIKELIHOOD_POSITION]});this.oTraversedLikelihood[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]][C[this.Constants.FIELDS.LIKELIHOOD_CODE]]=C[this.Constants.FIELDS.LIKELIHOOD_TEXT];}this._createPriorityMap.call(this,A[C[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]],C[this.Constants.FIELDS.CONSEQUENCE_CODE],C[this.Constants.FIELDS.LIKELIHOOD_CODE],C[this.Constants.FIELDS.MAINTPRIORITY],C[this.Constants.FIELDS.MAINTPRIORITYTYPE]);this.priorityType=C[this.Constants.FIELDS.MAINTPRIORITYTYPE];};var m=v.reduce(function(d,e,i){var n=!d.hasOwnProperty(e[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]);_.call(this,d,e,n);return d;}.bind(this),{});r(m);}.bind(this));},_createPriorityMap:function(r,s,l,p,c){if(!r.priorityMap.hasOwnProperty(s)){r.priorityMap[s]={};}r.priorityMap[s][l]={priority:p,priorityType:c};},onPressApply:function(e){this.byId("idEPMDialog").close();this.fireEvent("apply",{priority:this.getModel("epmModel").getProperty("/maintPriority"),priorityDesc:this.getModel("epmModel").getProperty("/maintPriorityDesc"),EventPrioritizationProfile:this.EventPrioritizationProfile,selectedItems:this.mapSelectedItems(this.getModel("epmModel").getProperty("/selectedItems")),lacdDate:this.getModel("epmModel").getProperty("/lacdDate"),requiredStartDate:this.sRequiredStartDate,requiredEndDate:this.sRequiredEndDate,requiredStartTime:this.sRequiredStartTime,requiredEndTime:this.sRequiredEndTime,priorityType:this.priorityType});},onPressAssess:function(e){var n=this.byId("empNavContainer");var d=this.byId("idEpmPageDisplayConsequences");n.to(d);this.getModel("epmModel").setProperty("/assesButtonVisible",false);this.getCalculatedFields();},onNavBack:function(e){var n=this.byId("empNavContainer");this.getModel("epmModel").setProperty("/assesButtonVisible",true);n.back();},onPressCancel:function(e){this.fireEvent("cancel");this.byId("idEPMDialog").close();}});return E;},true);
