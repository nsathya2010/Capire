/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/Object","sap/ui/generic/app/transaction/DraftContext","sap/ui/core/routing/History","sap/ui/model/Filter","sap/ui/model/FilterOperator","sap/ui/model/Sorter","sap/ui/core/format/DateFormat","../util/Constants","sap/base/Log"],function(O,D,H,F,a,S,b,C,L){"use strict";return O.extend("orion.maintreq.manage.util.DraftHandler",{oi18nBundle:null,oContext:null,_sDiscardAction:null,oMetaModel:null,constructor:function(A,v){this.oApplicationController=A;this.oDraftContext=new D(v.getModel());this.oMetaModel=v.getModel().getMetaModel();this.oView=v;this.oIndicator=null;this.sEntity=null;this.oi18nBundle=v.getModel("i18n").getResourceBundle();this._aObsoleteMessages=[];this._oFieldWatchers={};this.oView.getModel().attachPropertyChange(this.fnPropertyChanged,this);this.oView.getModel().attachBatchRequestSent(this._onBatchRequestSent,this);this.oView.getModel().attachMessageChange(this._onMessageChange,this);this.oView.getModel().attachBatchRequestCompleted(this._onBatchRequestCompleted,this);this._checkContext();},fnPropertyChanged:function(e){var c=e.getParameter("context");if(!this.oDraftContext.hasDraft(c)){return;}if(!this.oMetaModel.getODataEntitySet(c.getPath().split("(")[0].substring(1))){return;}var p=e.getParameter("path");this.oApplicationController.propertyChanged(p,c).then(function(E){L.debug(E);}).catch(this.fnErrorHandler);},fnErrorHandler:function(e){L.error(e);},_checkContext:function(r){if(!this.oContext){delete this.sEntityPath;this.oContext=this.oView.getBindingContext();}else if(!r){return;}if(this.oContext){this.sEntityPath=this.oContext.getPath();this.sEntityPath=this.sEntityPath.substr(1,this.sEntityPath.indexOf("(")-1);this._sDiscardAction=this.oDraftContext.getODataDraftFunctionImportName(this.oContext,"DiscardAction");}},registerDraftIndicator:function(i){this.oIndicator=i;this.oIndicator.clearDraftState();},confirmDiscardDraft:function(c,d){var t=this;return new Promise(function(r){var p=new sap.m.Popover({placement:sap.m.PlacementType.VerticalPreferedTop,showHeader:false,content:[new sap.ui.layout.VerticalLayout({content:[new sap.m.Text({text:"{i18n>ymsg.confirmDraftDeletion}",width:"16rem"}),new sap.m.Button({tooltip:"{i18n>xbut.discard}",text:"{i18n>xbut.discard}",width:"100%",press:r})]})],afterClose:function(){c.removeDependent(p);p.destroy();}}).addStyleClass("sapUiContentPadding");c.addDependent(p);p.openBy(c);}).then(function(){t.oView.setBusy(true);var o=t.discard(t.oContext);t.showDraftDiscardedMessage(d);o.finally(function(){t.oView.setBusy(false);if(sap.ushell&&sap.ushell.Container){var h=H.getInstance();if(h.getPreviousHash()!==undefined){window.history.back(-1);}else{var e=sap.ushell.Container.getService("CrossApplicationNavigation");if(e){e.toExternal({target:{shellHash:"#Shell-home"}});}}}});});},discard:function(c){var t=this;this.oContext=c;this._checkContext(true);return this._loadRootEntity().then(function(o){return t.oApplicationController.getTransactionController().deleteEntity(o,null,true);;});},discardDraft:function(c,p,i){var o,P;if(typeof c==="string"){P=c;}else if(typeof c==="object"&&c instanceof sap.ui.model.Context){o=c;P=o.getPath();}p=p||{};jQuery.extend(p,{batchGroupId:"Changes",changeSetId:"Changes",successMsg:"Changes were discarded",failedMsg:"Discarding of changes failed",forceSubmit:true});var h="lenient";p.headers={Prefer:"handling="+h};o=new sap.ui.model.Context(this.oView.getModel(),P);return this._callDiscard(o,p);},_callDiscard:function(c,p){var f=this.oDraftContext.getODataDraftFunctionImportName(c,"DiscardAction"),m=this.oView.getModel();p.functionImport=this.oMetaModel.getODataFunctionImport(f.split("/")[1]);p.urlParameters={MaintenanceNotification:"",IsActiveEntity:false,DraftUUID:c.getProperty("DraftUUID")};return new Promise(function(r,d){var s;s="/"+p.functionImport.name;m.callFunction(s,{method:p.functionImport.httpMethod,urlParameters:p.urlParameters,success:r,error:d,batchGroupId:p.batchGroupId,changeSetId:p.changeSetId,headers:p.headers,expand:p.expand});});},activateDraft:function(c){return this.oApplicationController.getTransactionController().getDraftController().activateDraftEntity(c,true);},_loadRootEntity:function(){var t=this;return new Promise(function(r,c){r(t.oContext.getPath());});},showDraftDiscardedMessage:function(c){sap.m.MessageToast.show(this.oi18nBundle.getText("xmsg.draftDiscarded"));},_onMessageChange:function(e){var m=e.getParameter("newMessages"),M=this.oView.getModel(),o=function(t,c,s){if(this.oView.getModel().getProperty(t)!==c){if(this._oFieldWatchers[s]){this._oFieldWatchers[s].destroy();delete this._oFieldWatchers[s];}var d=sap.ui.getCore().getMessageManager(),f=d.getMessageModel().getProperty("/");for(var j in f){if(f[j]&&f[j].getId()===s){d.removeMessages(m[j]);break;}}}};if(m.length>0){for(var i in m){var t=m[i].getTarget(),s=m[i].getId();if(jQuery.sap.endsWith(t,"/")){continue;}this._oFieldWatchers[s]=new sap.ui.model.Binding(M,t);this._oFieldWatchers[s].attachChange(jQuery.proxy(o,this,t,M.getProperty(t),s));}}},_onBatchRequestSent:function(e){var r=e.getParameter("requests");this._checkContext();if(!this.oContext){return;}for(var i in r){if(r[i].method==="MERGE"&&r[i].url.indexOf(this.sEntityPath)!==-1){if(this.oIndicator&&this.oIndicator.getState()!==sap.m.DraftIndicatorState.Saving){this.showDraftSaving();}}}},showDraftSaved:function(){this.oIndicator.showDraftSaved();this.oIndicator.setState(sap.m.DraftIndicatorState.Saved);},showDraftSaving:function(){this.oIndicator.showDraftSaving();this.oIndicator.setState(sap.m.DraftIndicatorState.Saving);},_onBatchRequestCompleted:function(e){var r=e.getParameter("requests"),R=e.getParameter("response");if(!this.oContext){return;}for(var i in r){if(r[i].method==="MERGE"&&r[i].url.indexOf(this.sEntityPath)!==-1){if(this._aObsoleteMessages.length>0){sap.ui.getCore().getMessageManager().removeMessages(this._aObsoleteMessages);this._aObsoleteMessages=[];}if(this.oIndicator){if(R.statusCode>400){this.oIndicator.clearDraftState();}else if(this.oIndicator.getState()!==sap.m.DraftIndicatorState.Saved){this.showDraftSaved();}}}}},destroy:function(){try{this.oView.getModel().detachBatchRequestSent(this._onBatchRequestSent,this);this.oView.getModel().detachBatchRequestCompleted(this._onBarchRequestCompleted,this);}finally{delete this.oApplicationController;delete this.oDraftContext;delete this.oContext;delete this.oIndicator;delete this.oView;}},getLatestDraftOfUser:function(){var t=this;return new Promise(function(r,c){t.oView.getModel().read("/"+C.ENTITY.WORK_REQUEST_TP,{filters:[new F({path:"IsActiveEntity",operator:a.EQ,value1:"false"}),new F({path:"HasActiveEntity",operator:a.EQ,value1:"false"}),new F({path:"MaintenanceNotification",operator:a.EQ,value1:""}),new F({path:"MaintEvtIsCreatedByCurrentUser",operator:a.EQ,value1:true})],sorters:[new S("LastChangeDateTime",true)],urlParameters:{"$select":"DraftUUID,LastChangeDateTime","$top":"1","$skip":"0"},success:function(d){if(d.results&&d.results.length>0){r({DraftUUID:d.results[0].DraftUUID,LastChangeDateTime:d.results[0].LastChangeDateTime});}else{c();}},error:function(){c();}});});},resumeDraftDialog:function(l){var t=this;return new Promise(function(r,c){var d=new sap.m.Dialog({contentWidth:"25rem",type:sap.m.DialogType.Message,title:"{i18n>xtit.resumeDraft}",content:[new sap.ui.layout.VerticalLayout({content:[new sap.m.Text({text:t.oi18nBundle.getText("ymsg.resumeCreateDraft",[b.getDateTimeInstance().format(l)])}).addStyleClass("sapUiSmallMarginBottom"),new sap.m.Text({text:"{i18n>ymsg.resumeOrDiscard}"})]})],escapeHandler:function(p){t.oView.setBusy(true);r();d.close();p.resolve();},beginButton:new sap.m.Button({id:"createWrButtonResumeDraft",tooltip:"{i18n>xbut.resume}",text:"{i18n>xbut.resume}",press:function(){t.oView.setBusy(true);r();d.close();}}),endButton:new sap.m.Button({id:"createWrButtonDiscardDraft",tooltip:"{i18n>xbut.discard}",text:"{i18n>xbut.discard}",press:function(){t.oView.setBusy(true);c();d.close();}})});t.oView.addDependent(d);d.open();});}});});
