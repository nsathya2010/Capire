/*
 * Copyright (C) 2009-2022 SAP SE or an SAP affiliate company. All rights reserved.
 */
sap.ui.define(["sap/ui/base/ManagedObject","sap/base/Log","sap/ui/model/Filter","sap/ui/model/FilterOperator"],function(M,L,F,a){"use strict";return M.extend("orion.maintreq.manage.util.NotificationConsequencePersistenceHelper",{metadata:{properties:{oView:{type:"object"}},events:{saved:{}}},oView:null,oModel:null,ConsequenceCategoryMap:{},sNotificationType:null,oPriorityMap:{},Constants:{GroupIdChanges:"Changes",ENTITY_SET:"C_MaintNotifEventPrioznTP",FIELDS:{PLANT:"Plant",PRIORITY_TYPE:"MaintPriorityType",NOTIFICATION_TYPE:"NotificationType",MAINTEVENTPRIOZNPROFILELABEL:"MaintEventPrioznProfileLabel",MAINTEVENTPRIOZNPRFL:"MaintEvtPrioritizationProfile",CONSEQUENCE_GROUP:"MaintEventConsequenceGroup",CONSEQUENCE_CATEGORY_CODE:"MaintEventCnsqncCategoryCode",CONSEQUENCE_CATEGORY_TITLE:"MaintEventCnsqncCategoryTitle",CONSEQUENCE_CATEGORY_SUB_TITLE:"MaintEvtCnsqncCategorySubTitle",CONSEQUENCE_CATEGORY_POSITION:"MaintEvtCnsqncCatPositionValue",CONSEQUENCE_CODE:"MaintEventConsequenceCode",CONSEQUENCE_TEXT:"MaintEvtConsequenceDescription",CONSEQUENCE_POSITION:"MaintEventCnsqncPositionValue",LIKELIHOOD_CODE:"MaintEventLikelihoodCode",LIKELIHOOD_TEXT:"MaintEvtLikelihoodDescription",LIKELIHOOD_POSITION:"MaintEvtLklihdPositionValue",MAINTPRIORITY:"MaintPriority",MAINTPRIORITYDESC:"MaintPriorityDesc",MAINTPRIORITYTYPE:"MaintPriorityType",LACD_DATE:"LACD_DATE",SELECTED_VALUES:"SELECTED_VALUES",LEADING_VALUES:"LEADING_VALUES"}},constructor:function(v){this.oView=v;this.oModel=v.getModel();return M.call(this);},getSelectedConsequences:function(){var t=this;var p=this.oView.getBindingContext().getPath();return new Promise(function(r){t.oModel.read(p+"/to_EventPrio",{success:function(c){return r(c.results);}});}).then(function(c){t.ConsequenceCategoryMap=c.reduce(function(b,i){b[i.MaintEventCnsqncCategoryCode]={MaintEventCnsqncCategoryCode:i.MaintEventCnsqncCategoryCode,MaintEventLikelihoodCode:i.MaintEventLikelihoodCode,MaintEventConsequenceCode:i.MaintEventConsequenceCode,donotDeleteFlag:false,DraftUUID:i.DraftUUID};return b;},{});return c;});},getPriorityColorCodeMap:function(n){var t=this;if(n!==this.sNotificationType){return new Promise(function(r){t.oModel.read("/I_PMNotificationPriority",{filters:[new F({path:t.Constants.FIELDS.PRIORITY_TYPE,operator:a.EQ,value1:n})],success:function(p){var P={};if(p&&p.results){P=p.results.reduce(function(b,i){b[i.MaintPriority]={MaintPriorityType:i.MaintPriorityType,MaintPriorityColorCode:i.MaintPriorityColorCode,MaintPriorityDesc:i.MaintPriority_Text};return b;},{});t.sNotificationType=n;t.oPriorityMap=P;return r(P);}else{t.sNotificationType=n;t.oPriorityMap={};return r({});}}});});}else{return Promise.resolve(t.oPriorityMap);}},saveEventPrioritisationDraftItem:function(s){var t=this,p=this.oView.getBindingContext().getPath();var m=this._mapNotificationConsequencs(s);if(Object.keys(this.ConsequenceCategoryMap).length===0){if(m.length>0){m.forEach(function(i){t._createConsequence(i,p);});}}else{if(m.length===0){Object.values(t.ConsequenceCategoryMap).forEach(function(i){var S=i[t.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE];var d=t._getChildEntityPath(i,t.ConsequenceCategoryMap[S]);t._deleteConsequence(d).then(function(){t.fireEvent("saved");});});}else{m.forEach(function(i){var S=i[t.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE];if(t.ConsequenceCategoryMap.hasOwnProperty(S)){var u=t._getChildEntityPath(i,t.ConsequenceCategoryMap[S]);t._updateConsequence(i,u).then(function(){t.fireEvent("saved");});t.ConsequenceCategoryMap[S].donotDeleteFlag=true;}else{t._createConsequence(i,p).then(function(){t.fireEvent("saved");});}});Object.values(t.ConsequenceCategoryMap).forEach(function(i){if(!i.donotDeleteFlag){var S=i[t.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE];var d=t._getChildEntityPath(i,t.ConsequenceCategoryMap[S]);t._deleteConsequence(d).then(function(){t.fireEvent("saved");});}});}}},_mapNotificationConsequencs:function(s){var t=this;var m=s.map(function(i){var o={};o[t.Constants.FIELDS.MAINTEVENTPRIOZNPRFL]=i[t.Constants.FIELDS.MAINTEVENTPRIOZNPRFL.toUpperCase()];o[t.Constants.FIELDS.CONSEQUENCE_GROUP]=i[t.Constants.FIELDS.CONSEQUENCE_GROUP.toUpperCase()];o[t.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE]=i[t.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE.toUpperCase()];o[t.Constants.FIELDS.CONSEQUENCE_CODE]=i[t.Constants.FIELDS.CONSEQUENCE_CODE.toUpperCase()];o[t.Constants.FIELDS.LIKELIHOOD_CODE]=i[t.Constants.FIELDS.LIKELIHOOD_CODE.toUpperCase()];return o;});return m;},_createConsequence:function(c,p){var t=this;c.MaintenanceNotification=this.oView.getBindingContext().getProperty("MaintenanceNotification");return new Promise(function(r,b){t.oModel.create(p+"/to_EventPrio",c,{groupId:t.Constants.GroupIdChanges,success:r,error:b});});},_updateConsequence:function(c,p){var t=this;c.MaintenanceNotification=this.oView.getBindingContext().getProperty("MaintenanceNotification");return new Promise(function(r,b){t.oModel.update(p,c,{groupId:t.Constants.GroupIdChanges,success:r,error:b});});},_deleteConsequence:function(p){var t=this;return new Promise(function(r,b){t.oModel.remove(p,{groupId:t.Constants.GroupIdChanges,success:r,error:b});});},_getChildEntityPath:function(i,o){var m=this.oView.getBindingContext().getProperty("MaintenanceNotification");return this.oModel.createKey("/"+this.Constants.ENTITY_SET,{DraftUUID:o.DraftUUID,MaintEventCnsqncCategoryCode:i[this.Constants.FIELDS.CONSEQUENCE_CATEGORY_CODE],MaintenanceNotification:m,IsActiveEntity:false});}});});
